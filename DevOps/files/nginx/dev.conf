server {
  listen 80 default_server;

  root /app/web;                 # Drupal web/docroot
  index index.php index.html;

  client_max_body_size 10M;
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log;

  # --- Clean URLs / front controller
  location / {
    try_files $uri /index.php?$query_string;
  }

  # --- Public files (allow direct; never execute PHP from here)
  location ^~ /sites/default/files/ {
    location ~ \.php$ { return 404; }
    try_files $uri $uri/ /index.php?$query_string;
    # (Optional caching headers go here)
  }

  # --- Block hidden files (.git, .env, etc.)
  location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
  }

  # --- Block Drupal source/config/templates
  location ~* \.(engine|inc|install|make|module|profile|po|sh|.*sql|theme|twig|tpl(\.php)?|xtmpl|yml|yaml|psd|log|ini|fla|swf|bak)$ {
    deny all;
    access_log off;
    log_not_found off;
  }

  # --- Block sensitive filenames anywhere in the tree (fixes /themes/.../package.json)
  location ~* (^|/)(composer\.json|composer\.lock|package\.json|package-lock\.json|pnpm-lock\.yaml|yarn\.lock|web\.config|\.env(\..*)?|vite\.config\.(js|ts)|webpack(\.config)?\.(js|cjs|mjs|ts)|postcss\.config\.(js|cjs|mjs|ts)|tailwind\.config\.(js|cjs|mjs|ts))$ {
    deny all;
    access_log off;
    log_not_found off;
  }

  # --- Never execute PHP inside /sites (user-writable area)
  location ~* ^/sites/.+\.php$ { return 404; }

  # --- PHP-FPM
  location ~ \.php$ {
    try_files $uri =404;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_index index.php;
    fastcgi_pass app:9000;      # your PHP-FPM upstream
    fastcgi_read_timeout 90;
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
  }
}
